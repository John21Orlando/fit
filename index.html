<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>CutLog — local-first</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">CL</div>
      <div class="titles">
        <div class="name">CutLog</div>
        <div class="sub">本地优先 · 只给你自己用</div>
      </div>
    </div>

    <nav class="tabs" aria-label="tabs">
      <button class="tab active" data-tab="dash">汇总</button>
      <button class="tab" data-tab="meals">饮食</button>
      <button class="tab" data-tab="workouts">训练</button>
      <button class="tab" data-tab="profile">个人</button>
      <button class="tab" data-tab="backup">备份</button>
    </nav>
  </header>

  <main class="container">
    <section id="view-dash" class="view active">
      <div class="grid2">
        <div class="card">
          <div class="cardTitle">今天</div>
          <div id="todaySummary" class="bigNumbers">加载中…</div>
          <div class="muted">摄入来自你的“最终入账”；训练消耗来自手填或心率导入估算。</div>
        </div>

        <div class="card">
          <div class="cardTitle">体重</div>
          <div class="row">
            <label>日期 <input id="wDate" type="date"></label>
            <label>体重(kg) <input id="wKg" type="number" step="0.1" min="30" max="200"></label>
            <button id="addWeight" class="btn">记录</button>
          </div>
          <div id="weightList" class="list"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">最近 7 天</div>
        <div id="weekSummary" class="week"></div>
      </div>
    </section>

    <section id="view-meals" class="view">
      <div class="card">
        <div class="cardTitle">记录一餐</div>
        <div class="grid">
          <label>时间 <input id="mealTime" type="datetime-local"></label>
          <label>类型
            <select id="mealType">
              <option>早餐</option><option>午餐</option><option>晚餐</option><option>加餐</option>
            </select>
          </label>
          <label class="wide">名称/描述 <input id="mealName" placeholder="例如：鸡腿饭 / 家常炒菜"></label>

          <div class="split wide">
            <div class="miniCard">
              <div class="miniTitle">外部估算 1（可选）</div>
              <div class="grid3">
                <label>kcal <input id="kcal1" type="number" step="1" min="0"></label>
                <label>P(g) <input id="p1" type="number" step="0.1" min="0"></label>
                <label>C(g) <input id="c1" type="number" step="0.1" min="0"></label>
                <label>F(g) <input id="f1" type="number" step="0.1" min="0"></label>
              </div>
              <div class="muted">例如 SnapCalorie / 其他 app 的结果。</div>
            </div>

            <div class="miniCard">
              <div class="miniTitle">外部估算 2（可选）</div>
              <div class="grid3">
                <label>kcal <input id="kcal2" type="number" step="1" min="0"></label>
                <label>P(g) <input id="p2" type="number" step="0.1" min="0"></label>
                <label>C(g) <input id="c2" type="number" step="0.1" min="0"></label>
                <label>F(g) <input id="f2" type="number" step="0.1" min="0"></label>
              </div>
              <div class="muted">用来对照“最不确定的餐”。</div>
            </div>

            <div class="miniCard">
              <div class="miniTitle">最终入账（你可改）</div>
              <div class="grid3">
                <label>kcal <input id="kcalFinal" type="number" step="1" min="0"></label>
                <label>P(g) <input id="pFinal" type="number" step="0.1" min="0"></label>
                <label>C(g) <input id="cFinal" type="number" step="0.1" min="0"></label>
                <label>F(g) <input id="fFinal" type="number" step="0.1" min="0"></label>
              </div>

              <div class="row">
                <button id="autoMergeMeal" class="btn ghost">用规则自动合并</button>
                <button id="textEstimateMeal" class="btn ghost">根据文字估算范围</button>
              </div>

              <div class="row">
                <div class="rangeInputs">
                  <input id="kcalLow" type="number" step="1" min="0" placeholder="kcal 下限">
                  <span class="rangeDash">—</span>
                  <input id="kcalHigh" type="number" step="1" min="0" placeholder="kcal 上限">
                </div>
                <label class="inline">不确定性 0~1 <input id="mealUnc" type="number" step="0.05" min="0" max="1" value="0.35"></label>
              </div>

              <div id="mealTextSuggestions" class="muted"></div>
              <div class="muted">建议：有克重/标签就尽量填更“窄”的范围；差异大时不要平均，直接手动改“最终入账/范围”。</div>
            </div>
          </div>


          <label class="wide">照片 <input id="mealPhoto" type="file" accept="image/*"></label>
          <label class="wide">备注 <textarea id="mealNote" rows="3" placeholder="家常菜：食材/大概用量/吃了多少比例；包装食品：每份多少克等。"></textarea></label>
        </div>

        <div class="row">
          <button id="addMeal" class="btn">添加</button>
          <button id="clearMealForm" class="btn ghost">清空表单</button>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">最近饮食</div>
        <div id="mealList" class="list"></div>
      </div>
    </section>

    <section id="view-workouts" class="view">
      <div class="card">
        <div class="cardTitle">记录训练（手填）</div>
        <div class="grid">
          <label>时间 <input id="woTime" type="datetime-local"></label>
          <label>类型 <input id="woType" placeholder="飞盘/跑步/力量/其他"></label>
          <label>时长(min) <input id="woDur" type="number" step="1" min="1"></label>
          <label>平均心率(bpm) <input id="woHr" type="number" step="1" min="40" max="220"></label>
          <label>RPE(1~10，可选) <input id="woRpe" type="number" step="1" min="1" max="10"></label>
          <label class="wide">备注 <textarea id="woNote" rows="3"></textarea></label>
        </div>
        <div class="row">
          <button id="addWorkoutManual" class="btn">添加并估算消耗</button>
          <button id="clearWoForm" class="btn ghost">清空表单</button>
        </div>
        <div class="muted">能耗使用 Keytel 心率方程（统计估算）；你可在“个人”里调校准系数。</div>
      </div>

      <div class="card">
        <div class="cardTitle">导入心率 CSV（更准）</div>
        <p class="muted">Zepp 的导出格式可能因设备/地区不同。本工具支持“选择列”映射：你只要导出 CSV（带时间戳 + 心率列）即可。</p>
        <div class="row">
          <input id="hrCsv" type="file" accept=".csv,text/csv" />
          <button id="importHrCsv" class="btn">读取并映射</button>
        </div>
        <div id="csvMapper" class="mapper hidden">
          <div class="grid">
            <label>时间列
              <select id="colTime"></select>
            </label>
            <label>心率列
              <select id="colHr"></select>
            </label>
            <label>类型 <input id="csvWoType" placeholder="飞盘/跑步/力量/其他"></label>
            <label>备注 <input id="csvWoNote" placeholder="可选"></label>
          </div>
          <div class="row">
            <button id="confirmImportCsv" class="btn">生成训练记录</button>
            <button id="cancelImportCsv" class="btn ghost">取消</button>
          </div>
          <div id="csvPreview" class="preview"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">最近训练</div>
        <div id="woList" class="list"></div>
      </div>
    </section>

    <section id="view-profile" class="view">
      <div class="card">
        <div class="cardTitle">个人信息</div>
        <div class="grid">
          <label>年龄 Age <input id="age" type="number" min="10" max="90" value="21"></label>
          <label>性别 Sex
            <select id="sex">
              <option value="male" selected>男 Male</option>
              <option value="female">女 Female</option>
            </select>
          </label>
          <label>体重 Weight (kg) <input id="weight" type="number" step="0.1" min="30" max="200" placeholder="例如 70"></label>
          <label>静息心率 HRrest (bpm, 可选) <input id="hrrest" type="number" min="30" max="120" placeholder="例如 55"></label>
          <label>最大心率 HRmax (bpm, 可选) <input id="hrmax" type="number" min="120" max="240" placeholder="默认 220-年龄"></label>
          <label>训练能耗校准系数 (默认 1.00) <input id="calFactor" type="number" step="0.01" min="0.7" max="1.3" value="1.00"></label>
        </div>
        <div class="row">
          <button id="saveProfile" class="btn">保存</button>
          <button id="resetProfile" class="btn ghost">重置</button>
        </div>
        <p class="muted">校准系数建议 0.90~1.10：当你发现“训练消耗长期偏高/偏低”时再调。</p>
      </div>
    </section>

    <section id="view-backup" class="view">
      <div class="card">
        <div class="cardTitle">备份 / 迁移</div>
        <div class="row">
          <button id="exportBtn" class="btn">导出 JSON（含照片）</button>
          <button id="exportNoPhotosBtn" class="btn ghost">导出 JSON（不含照片）</button>
        </div>
        <div class="row">
          <input id="importFile" type="file" accept="application/json" />
          <button id="importBtn" class="btn">导入 JSON</button>
        </div>
        <hr>
        <button id="wipeBtn" class="btn danger">清空本地数据</button>
        <p class="muted">注意：本应用不上传云端。清空后无法恢复，除非你有备份文件。</p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span id="status">准备就绪</span>
    <span class="muted">提示：建议用 VSCode Live Server 打开（支持离线缓存）。</span>
  </footer>

  <script src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
