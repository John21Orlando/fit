<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>CutLog — local-first</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">CL</div>
      <div class="titles">
        <div class="name">CutLog</div>
        <div class="sub">本地优先 · 只给你自己用</div>
      </div>
    </div>

    <nav class="tabs" aria-label="tabs">
      <button class="tab active" data-tab="dash">汇总</button>
      <button class="tab" data-tab="meals">饮食</button>
      <button class="tab" data-tab="workouts">训练</button>
      <button class="tab" data-tab="profile">个人</button>
      <button class="tab" data-tab="backup">备份</button>
    </nav>
  </header>

  <main class="container">
    <section id="view-dash" class="view active">
      <div class="grid2">
        <div class="card">
          <div class="cardTitle">今天</div>
          <div id="todaySummary" class="bigNumbers">加载中…</div>
          <div class="muted">饮食默认记录为「范围」；汇总会按你选择的预算口径（中值/上限）来计算剩余预算。</div>
        </div>

        <div class="card">
          <div class="cardTitle">体重</div>
          <div class="row">
            <label>日期 <input id="wDate" type="date"></label>
            <label>体重(kg) <input id="wKg" type="number" step="0.1" min="30" max="200"></label>
            <button id="addWeight" class="btn">记录</button>
          </div>
          <div id="weightList" class="list"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">最近 7 天（按预算口径统计）</div>
        <div id="weekSummary" class="week"></div>
      </div>
    </section>

    <section id="view-meals" class="view">
      <div class="card">
        <div class="cardTitle">记录一餐</div>

        <div class="grid">
          <label>时间 <input id="mealTime" type="datetime-local"></label>
          <label>类型
            <select id="mealType">
              <option>早餐</option><option>午餐</option><option>晚餐</option><option>加餐</option>
            </select>
          </label>

          <label class="wide">名称/描述 <input id="mealName" placeholder="例如：白斩鸡 + 米饭；葡萄干 20 粒"></label>

          <div class="miniCard wide">
            <div class="miniTitle">结果（自动估算，可手改）</div>
            <div class="grid3">
              <label>kcal 中值 <input id="kcalFinal" type="number" step="1" min="0" placeholder="自动"></label>
              <label>kcal 下限 <input id="kcalLow" type="number" step="1" min="0" placeholder="自动"></label>
              <label>kcal 上限 <input id="kcalHigh" type="number" step="1" min="0" placeholder="自动"></label>
              <label>不确定性 0~1 <input id="mealUnc" type="number" step="0.05" min="0" max="1" value="0.35"></label>
            </div>
            <div id="mealTextSuggestions" class="muted"></div>
            <div class="muted">只写文字也会自动估算范围；你手动改过这些字段后将不再自动覆盖（把它们清空可恢复自动）。</div>
          </div>

          <label class="wide">照片（可选） <input id="mealPhoto" type="file" accept="image/*"></label>
          <label class="wide">备注（可选） <textarea id="mealNote" rows="3" placeholder="写清楚份量会更准：例如“一碗米饭/180g”“一小把葡萄干(20粒)”"></textarea></label>
        </div>

        <div class="row">
          <button id="addMeal" class="btn">添加</button>
          <button id="clearMealForm" class="btn ghost">清空表单</button>
          <span class="muted">无需按任何估算按钮，输入文字会自动估算。</span>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">最近饮食</div>
        <div id="mealList" class="list"></div>
      </div>
    </section>

    <section id="view-workouts" class="view">
      <div class="card">
        <div class="cardTitle">记录训练（手填）</div>
        <div class="grid">
          <label>时间 <input id="woTime" type="datetime-local"></label>
          <label>类型 <input id="woType" placeholder="飞盘/跑步/力量/其他"></label>
          <label>时长(min) <input id="woDur" type="number" step="1" min="1"></label>
          <label>平均心率(bpm) <input id="woHr" type="number" step="1" min="40" max="220"></label>
          <label>RPE(1~10，可选) <input id="woRpe" type="number" step="1" min="1" max="10"></label>
          <label class="wide">备注 <textarea id="woNote" rows="3"></textarea></label>
        </div>
        <div class="row">
          <button id="addWorkoutManual" class="btn">添加并估算消耗</button>
          <button id="clearWoForm" class="btn ghost">清空表单</button>
        </div>
        <div class="muted">能耗使用 Keytel 心率方程（统计估算）；你可在“个人”里调校准系数。</div>
      </div>

      <div class="card">
        <div class="cardTitle">导入心率 CSV（更准）</div>
        <p class="muted">支持“选择列”映射：导出 CSV（带时间戳 + 心率列）即可。</p>
        <div class="row">
          <input id="hrCsv" type="file" accept=".csv,text/csv" />
          <button id="importHrCsv" class="btn">读取并映射</button>
        </div>
        <div id="csvMapper" class="mapper hidden">
          <div class="grid">
            <label>时间列
              <select id="colTime"></select>
            </label>
            <label>心率列
              <select id="colHr"></select>
            </label>
            <label>类型 <input id="csvWoType" placeholder="飞盘/跑步/力量/其他"></label>
            <label>备注 <input id="csvWoNote" placeholder="可选"></label>
          </div>
          <div class="row">
            <button id="confirmImportCsv" class="btn">生成训练记录</button>
            <button id="cancelImportCsv" class="btn ghost">取消</button>
          </div>
          <div id="csvPreview" class="preview"></div>
        </div>
      </div>

      <div class="card">
        <div class="cardTitle">最近训练</div>
        <div id="woList" class="list"></div>
      </div>
    </section>

    <section id="view-profile" class="view">
      <div class="card">
        <div class="cardTitle">个人信息</div>
        <div class="grid">
          <label>年龄 Age <input id="age" type="number" min="10" max="90" value="21"></label>
          <label>性别 Sex
            <select id="sex">
              <option value="male" selected>男 Male</option>
              <option value="female">女 Female</option>
            </select>
          </label>
          <label>体重 Weight (kg) <input id="weight" type="number" step="0.1" min="30" max="200" placeholder="例如 70"></label>
          <label>静息心率 HRrest (bpm, 可选) <input id="hrrest" type="number" min="30" max="120" placeholder="例如 55"></label>
          <label>最大心率 HRmax (bpm, 可选) <input id="hrmax" type="number" min="120" max="240" placeholder="默认 220-年龄"></label>
          <label>训练能耗校准系数 (默认 1.00) <input id="calFactor" type="number" step="0.01" min="0.7" max="1.3" value="1.00"></label>

          <label>每日目标 Target kcal <input id="targetKcal" type="number" step="10" min="800" max="6000" placeholder="例如 2100"></label>
          <label>预算口径 Budget mode
            <select id="budgetMode">
              <option value="mid" selected>按中值（mid）</option>
              <option value="high">按上限（high，更保守）</option>
            </select>
          </label>
        </div>
        <div class="row">
          <button id="saveProfile" class="btn">保存</button>
          <button id="resetProfile" class="btn ghost">重置</button>
        </div>
        <p class="muted">预算口径：你想更保守控热量，就用“按上限(high)”；日常更平衡，就用“按中值(mid)”。</p>
      </div>
    </section>

    <section id="view-backup" class="view">
      <div class="card">
        <div class="cardTitle">备份 / 迁移</div>
        <div class="row">
          <button id="exportBtn" class="btn">导出 JSON（含照片）</button>
          <button id="exportNoPhotosBtn" class="btn ghost">导出 JSON（不含照片）</button>
        </div>
        <div class="row">
          <input id="importFile" type="file" accept="application/json" />
          <button id="importBtn" class="btn">导入 JSON</button>
        </div>
        <hr>
        <button id="wipeBtn" class="btn danger">清空本地数据</button>
        <p class="muted">注意：本应用不上传云端。清空后无法恢复，除非你有备份文件。</p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <span id="status">准备就绪</span>
    <span class="muted">建议用 VSCode Live Server 打开（支持离线缓存）。</span>
  </footer>

  <script src="app.js"></script>
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./sw.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
